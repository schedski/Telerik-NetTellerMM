define(["lib/jquery","netteller/session","ui/loader","lib/knockout","netteller/contacts","config/environment","netteller/authentication","lib/toolkit","ui/validation","ui/startup"],function(e,t,n,r,i,s,o,u){var a=new n.TimedLoader(s.strings["loader.addingcontact"]),f=new n.TimedLoader(s.strings["loader.wait"]),l={BSBDetails:r.observable(""),PayeeAccountName:r.observable("").extend({required:{params:!0,message:s.strings["msg.required"]}}),PayeeBSB:r.observable("").extend({isRequiredAndValidLength:{minLength:6,maxLength:6,isNumber:!0,fieldOrMessage:"msg:"+s.strings["msg.invalidbsb"]}}),PayeeAccountNumber:r.observable("").extend({required:{params:!0,message:s.strings["msg.required"]}}),PayeeIsInternal:r.observable(!1),reset:function(){l.PayeeAccountName(""),l.PayeeBSB(""),l.PayeeAccountNumber(""),l.PayeeIsInternal(""),l.BSBDetails(""),l.PayeeBSB.isModified(!1),l.errors.showAllMessages(!1)},submitPayee:function(){if(l.errors().length>0){l.errors.showAllMessages();return}if(!l.isPayeeValid())return;f.reset(),f.show(),o.getAddPayeeSecurityDevices(v.getAddPayeeDevicesHandler)},isPayeeValid:function(){var t=!0;try{e.each(i.allContacts(),function(n,r){if(r.ContactType()===i.ContactType.Payee){var o=r.ViewModelItem;o.BSB!==l.PayeeBSB()&&o.BSBWithoutDash!==l.PayeeBSB()||o.AccountNumber!==l.PayeeAccountNumber()||o.UserEnteredName.toLowerCase()!==l.PayeeAccountName().toLowerCase()?o.BSB!==l.PayeeBSB()&&o.BSBWithoutDash!==l.PayeeBSB()||o.AccountNumber!==l.PayeeAccountNumber()?o.UserEnteredName.toLowerCase()===l.PayeeAccountName().toLowerCase()&&(u.displayPageMessage(d,"pageMessage",s.strings["msg.payeenicknamealreadyused"],e("#addContactMessagePopup")),t=!1):(u.displayPageMessage(d,"pageMessage",s.strings["msg.payeealreadyexists2"],e("#addContactMessagePopup")),t=!1):(u.displayPageMessage(d,"pageMessage",s.strings["msg.payeealreadyexists1"],e("#addContactMessagePopup")),t=!1)}})}catch(n){}return t},submitData:null,confirmed:function(){e("#addPayeeConfirm").popup("close"),a.reset(),a.show(),i.addPayee(l.submitData,v.authorisationCode,l.contactSubmitResultHandler);var t=l.submitData;i.selectedContact={ContactType:i.ContactType.Payee,AccountName:l.PayeeAccountName(),AccountNumber:l.PayeeAccountNumber(),BSB:l.PayeeBSB(),IsInternal:l.PayeeIsInternal(),UserEnteredName:t.UserEnteredName,getContactType:function(){return i.ContactType.Payee},getDescriptionString:function(){return!t.UserEnteredName||0===t.UserEnteredName.length?l.PayeeAccountName():t.UserEnteredName}}},contactSubmitResultHandler:function(t){a.loadFinished(),t.ContactType===i.ContactType.Payee&&(t.IsVerified===!1?u.displayPageMessage(d,"pageMessage",s.strings["msg.payeebsbverifyfailed"],e("#addContactMessagePopup")):i.activeContactsFilter!==null?(i.activeContactsFilter=null,e.mobile.changePage("#payOther",{transition:"none",reverse:!0})):(l.PayeeBSB(""),l.BSBDetails(""),l.reset(),i.newContactTypeAdded=i.ContactType.Payee,e.mobile.changePage("#contacts")))},populateBSBDetails:function(t){t.Success===!0?(l.BSBDetails(t.Name+(u.hasValue(t.Branch)?" | "+t.Branch:"")),l.errors.showAllMessages(!1)):(l.PayeeBSB(""),l.BSBDetails(""),l.PayeeBSB.isModified(!0),e("#addPayeeBsb").focus())}};l.PayeeBSB.subscribe(function(t){t=e.trim(t),u.hasValue(t)===!0&&t.length===6?i.getBSBDetails(t,l.populateBSBDetails):(l.PayeeBSB(""),l.BSBDetails(""))}),l.errors=r.validation.group(l);var c={BillerName:r.observable("").extend({required:{params:!0,message:s.strings["msg.required"]}}),BillerNickName:r.observable(""),BillerCode:r.observable("").extend({required:{params:!0,message:s.strings["msg.invalidbillercode"]}}),BillerCRN:r.observable("").extend({required:{params:!0,message:s.strings["msg.required"]}}),DisableCRNField:r.observable(!1),IsCRNConstant:!1,reset:function(){c.BillerName(""),c.BillerNickName(""),c.BillerCode(""),c.BillerCRN(""),c.IsCRNConstant=!1,c.DisableCRNField(!1),c.errors.showAllMessages(!1)},submitBiller:function(){if(c.errors().length>0){c.errors.showAllMessages();return}if(!c.isBillerValid())return;f.reset(),f.show(),o.getAddBillerSecurityDevices(v.getAddBillerDevicesHandler)},isBillerValid:function(){var t=!0;try{e.each(i.allContacts(),function(n,r){if(r.ContactType()===i.ContactType.Biller){var o=r.ViewModelItem;o.BillerCode===c.BillerCode()&&o.CustomerReferenceNumber===c.BillerCRN()&&o.UserEnteredName.toLowerCase()===c.BillerNickName().toLowerCase()?(u.displayPageMessage(d,"pageMessage",s.strings["msg.billeralreadyexists1"],e("#addContactMessagePopup")),t=!1):o.BillerCode===c.BillerCode()&&o.CustomerReferenceNumber===c.BillerCRN()?(u.displayPageMessage(d,"pageMessage",s.strings["msg.billeralreadyexists2"],e("#addContactMessagePopup")),t=!1):o.UserEnteredName.toLowerCase()===c.BillerNickName().toLowerCase()&&(u.displayPageMessage(d,"pageMessage",s.strings["msg.billernicknamealreadyused"],e("#addContactMessagePopup")),t=!1)}})}catch(n){}return t},submitData:null,confirmed:function(){e("#addBillerConfirm").popup("close"),a.reset(),a.show(),i.addBiller(c.submitData,v.authorisationCode,c.contactSubmitResultHandler);var t=c.submitData;i.selectedContact={ContactType:i.ContactType.Biller,BillerCode:c.BillerCode(),CustomerReferenceNumber:c.BillerCRN(),IsCRNConstant:c.IsCRNConstant,ShortName:t.ShortName,UserEnteredName:t.UserEnteredName,getContactType:function(){return i.ContactType.Biller},getDescriptionString:function(){return!t.UserEnteredName||0===t.UserEnteredName.length?t.ShortName:t.UserEnteredName}},i.isValidCreditCardNumber(c.BillerCRN(),c.isValidCreditCardNumberHandler)},isValidCreditCardNumberHandler:function(e){i.selectedContact!==null&&(i.selectedContact.IsCRNPAN=e.Value)},contactSubmitResultHandler:function(t){a.loadFinished(),t!=={}&&t.Success===!0&&t.ContactType===i.ContactType.Biller?i.activeContactsFilter!==null?(i.activeContactsFilter=null,e.mobile.changePage("#payBpay",{transition:"none",reverse:!0})):(i.newContactTypeAdded=i.ContactType.Biller,e.mobile.changePage("#contacts")):u.displayPageMessage(d,"pageMessage",s.strings["msg.billersavefail"],e("#addContactMessagePopup")),c.reset()},prePopulateBillerData:function(t){t.Success===!0&&t.Biller!==undefined&&e.trim(String(t.Biller.ShortName))!==""?(c.BillerName(t.Biller.ShortName),t.Biller.IsCRNConstant===!0&&(c.IsCRNConstant=!0,u.hasValue(t.Biller.CRN)===!0?(c.BillerCRN(t.Biller.CRN),c.DisableCRNField(!0)):c.DisableCRNField(!1)),h.isCRNConstant(c.IsCRNConstant),c.BillerCode.isModified(!1)):(c.reset(),c.BillerCode.isModified(!0),c.BillerCRN.isModified(!1),e("#addBillerBcode").focus())}};c.BillerCode.subscribe(function(t){u.hasValue(c.BillerCode())===!0&&i.getBillerData(e.trim(t),c.prePopulateBillerData)}),c.errors=r.validation.group(c);var h={isCRNConstant:r.observable(!1),confirmed:function(){c.confirmed()},reset:function(){h.isCRNConstant(!1)}},p={confirmed:function(){l.confirmed()}},d={pageMessage:r.observable(""),reset:function(){d.pageMessage("")}},v={errorMessage:r.observable(""),contactDeclaration:new Array,authorisationCode:"",submitType:i.ContactType.All,Instruction:r.observable(""),IsAuthenticated:!1,Device:r.observable(null),Devices:r.observableArray(),IsSmsDevice:r.computed({read:function(){var e=v.Device();return u.hasValue(e)?e.DeviceType===1:!1},deferEvaluation:!0}),IsTokenDevice:r.computed({read:function(){var e=v.Device();return u.hasValue(e)?e.DeviceType===2:!1},deferEvaluation:!0}),IsPasswordDevice:r.computed({read:function(){var e=v.Device();return u.hasValue(e)?e.DeviceType===3:!1},deferEvaluation:!0}),waitOnNextSend:!1,infoMessage:r.observable(""),answer:r.observable("").extend({required:{params:!0,message:s.strings["msg.auth.invalidtoken"]}}),smsSent:r.observable(!1),reset:function(){v.resetForm(),v.IsAuthenticated=!1,v.submitType=i.ContactType.All,v.Instruction(""),v.waitOnNextSend=!1},resetForm:function(){v.answer(""),v.infoMessage(""),v.smsSent(!1),v.contactDeclaration=new Array,v.authorisationCode="",v.answer.isModified(!1),e("#answer").attr("placeholder",s.strings["lang.placeholder.onetimepassword"])},sendOneTimePassword:function(){v.Device!=null&&!v.waitOnNextSend&&(v.waitOnNextSend=!0,o.sendOneTimePasswordSMS(v.Device(),v.otpHandler))},otpHandler:function(e){v.infoMessage(e.Success===!0?s.strings["msg.auth.tokensent"]:s.strings["msg.auth.autherror"]),v.smsSent(e.Success===!0),setTimeout(function(){v.waitOnNextSend=!1},500)},validateToken:function(){if(v.errors().length>0){e("#answer").attr("placeholder",""),v.errors.showAllMessages();return}var t;v.IsSmsDevice()?t=o.authenticateWithSmsDevice:v.IsTokenDevice()?t=o.authenticateWithTokenDevice:t=o.authenticateWithPasswordDevice,t(v.answer(),v.Device(),v.contactDeclaration,v.validateTokenHandler)},validateTokenHandler:function(n){if(n.Success&&n.IsAuthenticated)v.IsAuthenticated=!0,v.authorisationCode=n.AuthorisationCode,setTimeout(function(){v.submitType===i.ContactType.Biller?c.submitBiller():v.submitType===i.ContactType.Payee&&l.submitPayee()},500);else{if(n.IsLockedOut){t.logout(),e(document).trigger("tsw-account-locked-from-authentication-device");return}n.NumberOfAttempts===2?v.infoMessage(s.strings["msg.auth.invalidtokenpenultimateattempt"]):(v.answer.isModified(!0),e("#answer").attr("placeholder","")),v.answer("")}},getAddPayeeDevicesHandler:function(t){f.loadFinished(function(){v.populateDevices(t);var n={UserEnteredName:l.PayeeAccountName(),IsInternal:l.PayeeIsInternal(),Account:{AccountName:l.PayeeAccountName(),AccountNumber:l.PayeeAccountNumber(),BSB:l.PayeeBSB()}};l.submitData=n,v.Devices().length>0&&!v.IsAuthenticated?(v.submitType=i.ContactType.Payee,v.resetForm(),v.contactDeclaration=[l.PayeeBSB(),l.PayeeAccountNumber()],e("#authenticateViaDevicePopup").popup("open")):v.Devices().length==0&&u.hasValue(t.RestrictMemberWithNoSecurityDevices)&&!t.RestrictMemberWithNoSecurityDevices?e("#addPayeeConfirm").popup("open"):v.IsAuthenticated&&e("#authenticateViaDevicePopup").popup("close")})},getAddBillerDevicesHandler:function(t){f.loadFinished(function(){v.populateDevices(t);var n={BillerCode:c.BillerCode(),CRN:c.BillerCRN(),ShortName:c.BillerName(),IsCRNConstant:c.IsCRNConstant,UserEnteredName:c.BillerNickName()};c.submitData=n,v.Devices().length>0&&!v.IsAuthenticated?(v.submitType=i.ContactType.Biller,v.resetForm(),v.contactDeclaration=[c.BillerCode(),c.BillerCRN()],e("#authenticateViaDevicePopup").popup("open")):v.Devices().length==0&&u.hasValue(t.RestrictMemberWithNoSecurityDevices)&&!t.RestrictMemberWithNoSecurityDevices?e("#addBillerConfirm").popup("open"):v.IsAuthenticated&&e("#authenticateViaDevicePopup").popup("close")})},populateDevices:function(t){v.Devices.removeAll(),v.Device(null),v.errorMessage(""),v.answer.isModified(!1),v.smsSent(!1),e("#answer").attr("placeholder",""),u.hasValue(t.SmsDevices)&&r.utils.arrayPushAll(v.Devices,t.SmsDevices),u.hasValue(t.TokenDevices)&&r.utils.arrayPushAll(v.Devices,t.TokenDevices),u.hasValue(t.PasswordDevices)&&r.utils.arrayPushAll(v.Devices,t.PasswordDevices);if(v.Devices().length==0&&u.hasValue(t.RestrictMemberWithNoSecurityDevices)&&t.RestrictMemberWithNoSecurityDevices){v.errorMessage(s.strings["msg.frozendevices"]),e("#authenticateViaDevicePopup").popup("open");return}u.hasValue(t.SmsDevices)&&u.hasValue(t.SmsDevices[0])&&u.hasValue(t.SmsDevices[0].MobileNumber)&&v.Instruction(s.strings["msg.auth.sendtokentomobile"].replace("{0}",t.SmsDevices[0].MobileNumber))}};v.errors=r.validation.group(v),e("#AuthenticationDeviceSelectList").on("change",function(){v.infoMessage(""),v.answer("")}),t.viewModels.push(c),t.viewModels.push(l),t.viewModels.push(p),t.viewModels.push(h),t.viewModels.push(d),t.viewModels.push(v),e("#addContact").on("pageinit",function(){e("#authenticateViaDevicePopup").popup("close"),c.reset(),l.reset(),d.reset(),r.applyBindings(l,e("#payeeCollapsible").get(0)),r.applyBindings(c,e("#billerCollapsible").get(0)),r.applyBindings(h,e("#addBillerConfirm").get(0)),r.applyBindings(p,e("#addPayeeConfirm").get(0)),r.applyBindings(d,e("#addContactMessagePopup").get(0)),r.applyBindings(v,e("#authenticateViaDevicePopup").get(0)),e("#authenticateViaDevicePopup").on({popupbeforeposition:function(){e(".ui-popup-screen").off()}})}),e("#addContact").on("pagebeforeshow",function(){c.reset(),l.reset(),d.reset(),v.answer.isModified(!1)}),e("#addContact").on("pageshow",function(){i.activeContactsFilter!==null?e(i.activeContactsFilter===i.ContactType.Payee?"#payeeCollapsible":"#billerCollapsible").trigger("expand"):i.addContactsFilter!==null?e(i.addContactsFilter===i.ContactType.Payee?"#payeeCollapsible":"#billerCollapsible").trigger("expand"):(e("#payeeCollapsible").trigger("collapse"),e("#billerCollapsible").trigger("collapse"))}),e("#addContact").on("pagebeforehide",function(){i.addContactsFilter=null,i.activeContactsFilter=null}),e("#addContact").on("pagehide",function(){c.reset(),l.reset(),d.reset()}),e("#authenticateViaDevicePopup").on("popupafterclose",function(){setTimeout(function(){u.hasValue(l.PayeeBSB())&&l.PayeeBSB().length>0&&v.IsAuthenticated?(v.IsAuthenticated=!1,e("#addPayeeConfirm").popup("open")):u.hasValue(c.BillerCode())&&c.BillerCode().length>0&&c.isBillerValid()&&v.IsAuthenticated&&(v.IsAuthenticated=!1,e("#addBillerConfirm").popup("open"))},100)})})