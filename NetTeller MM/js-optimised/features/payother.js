define(["lib/jquery","lib/knockout","ui/loader","lib/accounting","netteller/accounts","netteller/transactions","netteller/payments","netteller/session","netteller/contacts","config/environment","ui/contactHelper","lib/toolkit","ui/validation"],function(e,t,n,r,i,s,o,u,a,f,l,c){var h=new n.TimedLoader(f.strings["loader.accounts"]),p=new n.TimedLoader(f.strings["loader.payments"]),d=e.Deferred(),v=function(e){var n=this;this.AccountName=t.observable(e.AccountName),this.DisplayAccountName=t.observable(e.DisplayAccountName),this.BSB=t.observable(e.BSBWithDash),this.AccountNumber=t.observable(e.AccountNumber),this.DisplayAccountNumber=t.observable(e.DisplayAccountNumber),this.AvailableBalance=t.observable(Number(e.AvailableBalance)),this.DisplayAvailableBalance=t.computed(function(){return r.formatMoney(n.AvailableBalance())}),this.AccountNumAndName=n.DisplayAccountNumber()+": "+n.DisplayAccountName(),this.AccountNumNameAndAvailBal=n.AccountNumAndName+" ("+n.DisplayAvailableBalance()+")",this.AccountType=t.observable(e.AccountType)},m={allowTransfer:t.observable(!1),transferFromAccounts:t.observableArray([]),payOtherTransferFromSelectedAccount:t.observable(null),payOtherTransferFromSelectedAccountNameAndNum:t.observable(null),selectedContact:t.observable(null),amount:t.observable("").extend({minAmount:.01}).extend({maxAmount:9999999999}),description:t.observable("").extend({required:{params:!0,message:f.strings["msg.required"]}}),pageMessage:t.observable(""),isMessageVisible:t.observable(!1),HasPayees:t.observable(!1),selectedContactAccountName:t.computed({read:function(){if(m.selectedContact()!==null){var e=m.selectedContact().getDescriptionString();return g.selectedContactAccountName(e),e}return f.strings["lang.label.chooseexistingpayee"]},deferEvaluation:!0}),selectedContactAccountBSBAndNumber:t.computed({read:function(){if(m.selectedContact()!==null){var e="BSB "+m.selectedContact().BSB+", Account no. "+m.selectedContact().AccountNumber;return g.selectedContactAccountBSBAndNumber(e),e}return null},deferEvaluation:!0}),selectedContactImage:t.computed({read:function(){return m.selectedContact()!==null?l.getContactTypeImageSrc(a.ContactType.Payee):l.getContactTypeImageSrc(a.ContactType.All)},deferEvaluation:!0}),reset:function(){m.clear()},clear:function(){m.selectedContact(null),m.amount(""),m.description(""),m.isMessageVisible(!1),m.allowTransfer(!1),m.pageMessage(""),m.errors.showAllMessages(!1),m.HasPayees(!1)},selectContact:function(){a.activeContactsFilter=a.ContactType.Payee;var t=m.HasPayees()?"#contacts":"#addContact";e.mobile.changePage(t,{transition:"none"})},confirmPayOtherDetails:function(){if(m.selectedContact()==null){e("#choosePayeePopup").popup("open");return}if(m.errors().length>0){m.errors.showAllMessages();return}var t=m.amount();m.amount(parseFloat(isNaN(t)||t===""||t===null?0:t).toFixed(2)),m.payOtherTransferFromSelectedAccountNameAndNum(m.payOtherTransferFromSelectedAccount().DisplayAccountName()+" ("+m.payOtherTransferFromSelectedAccount().DisplayAccountNumber()+")"),e("#payOtherConfirm").popup("open")},performPayOtherTransfer:function(){e("#payOtherConfirm").popup("close"),p.reset(),p.show(),o.executePayOtherFundsTransfer(m.payOtherTransferFromSelectedAccount().AccountNumber(),m.selectedContact().AccountNumber,m.selectedContact().AccountName,m.selectedContact().BSB,m.amount(),m.description(),o.frequency.Immediate,b),d.done(function(t){t!==null&&t!==undefined&&t.length>0&&c.displayPageMessage(m,"pageMessage",t,e("#payOtherMessagePopup"))})},addPayee:function(){a.activeContactsFilter=a.ContactType.Payee,e.mobile.changePage("#addContact",{transition:"none"})},choosePayee:function(){a.activeContactsFilter=a.ContactType.Payee;var t=m.HasPayees()?"#contacts":"#addContact";e.mobile.changePage(t,{transition:"none"})}};m.errors=t.validation.group(m);var g={transferFromAccountNumAndName:t.observable(),selectedContactAccountName:t.observable(),selectedContactAccountBSBAndNumber:t.observable(),amount:t.observable(),cbsReceiptNumber:t.observable(),description:t.observable(),reset:function(){g.transferFromAccountNumAndName(""),g.selectedContactAccountName(""),g.selectedContactAccountBSBAndNumber(""),g.amount(""),g.cbsReceiptNumber(""),g.description("")}};u.viewModels.push(m),u.viewModels.push(g);var y=function(t){var n=function(){m.transferFromAccounts.removeAll(),e.each(t.Accounts,function(e,t){m.transferFromAccounts.push(new v(t))})};t.Accounts===undefined||t.Accounts.length===0?(m.allowTransfer(!1),c.displayPageMessage(m,"pageMessage",f.strings["msg.noaccounts"],e("#payOtherMessagePopup")),h.loadFinished()):(h.loadFinished(n),m.allowTransfer(!0))},b=function(t){t.Success?(g.transferFromAccountNumAndName(t.FromDisplayAccountName+" ("+t.FromDisplayAccountNumber+")"),g.amount(m.amount()),g.cbsReceiptNumber(t.CBSReceiptNumber),g.description(m.description()),p.loadFinished(),e.mobile.changePage("#payOtherReceipt")):(p.loadFinished(function(){d.resolve(t.ErrorMessage),d=e.Deferred()}),e("#payOtherConfirm").popup("close"))};e("#payOther").on("pageinit",function(){t.applyBindings(m,e("#payOther").get(0)),t.applyBindings(g,e("#payOtherReceipt").get(0))}),e("#payOther").on("pagebeforeshow",function(e,t){if(t.prevPage.attr("id")==="payments"||m.transferFromAccounts().length==0)m.clear(),h.reset(),h.startBackgroundLoad(),i.getFteTransferFromAccounts(y);a.contactTypeCount(a.ContactType.Payee,function(e){m.HasPayees(e>0)})}),e("#payOther div[data-role='footer'] a").on("click",function(){m.clear(),i.getFteTransferFromAccounts(y)}),e("#payOther").on("pageshow",function(){h.show(),m.errors.showAllMessages(!1),a.selectedContact!==null&&a.selectedContact.getContactType()===a.ContactType.Payee&&(m.selectedContact(a.selectedContact),a.selectedContact.IsNew!==undefined&&a.selectedContact.IsNew===!0&&(c.displayPageMessage(m,"pageMessage",f.strings["msg.payeesaved"],e("#payOtherMessagePopup")),a.activeContactsFilter=null))})})