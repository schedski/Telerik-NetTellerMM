define(["lib/jquery","netteller/session","ui/loader","lib/knockout","netteller/contacts","ui/contactHelper","config/environment","lib/underscore","ui/startup"],function(e,t,n,r,i,s,o,u){var a=new n.TimedLoader(o.strings["loader.contacts"]),f=function(e){var t=this;this.ViewModelItem=e,this.DisplayString=r.observable(e.getDescriptionString()),this.MetaInfoString=r.observable(e.getMetaInfoString()),this.SortableItem=r.observable(e.getSortableItem()),this.ContactType=r.observable(e.getContactType()),this.ContactTypeImage=r.computed({read:function(){return s.getContactTypeImageSrc(t.ContactType())},deferEvaluation:!0})},l={contacts:r.observableArray([]),InPickState:r.observable(!1),reset:function(){l.contacts([]),l.HasContacts(!1),l.HasPayees(!1),l.HasBillers(!1),l.ShowContent(!1),l.TypeFilter(0),l.InPickState(!1)},GroupedContactsList:r.computed({read:function(){var e=l.contacts();l.TypeFilter()===i.ContactType.Payee&&(e=u.filter(l.contacts(),function(e){return e.ContactType()==i.ContactType.Payee})),l.TypeFilter()===i.ContactType.Biller&&(e=u.filter(l.contacts(),function(e){return e.ContactType()==i.ContactType.Biller}));var t=u.groupBy(e,function(e){return e.SortableItem().toString().charAt(0).toUpperCase()}),n=u.reduce(t,function(e,t){return e.push({LetterGroup:u.first(t).SortableItem().toString().charAt(0).toUpperCase(),Contacts:u.sortBy(t,function(e){return e.SortableItem()})}),e},[]);return u.sortBy(n,function(e){return e.LetterGroup})},deferEvaluation:!0}),ShowContent:r.observable(!1),HasContacts:r.observable(!1),HasPayees:r.observable(!1),HasBillers:r.observable(!1),NoContactsMessage:r.observable(""),NoPayeesMessage:r.observable(""),NoBillersMessage:r.observable(""),TypeFilter:r.observable(0),getTypeFilter:function(){return l.TypeFilter()},filterByContactType:function(e){l.TypeFilter(parseInt(e))},SelectContact:function(t){i.selectedContact=t.ViewModelItem,t.ContactType()===i.ContactType.Biller?(i.hasBillers=!0,e.mobile.changePage("#payBpay",{transition:"none"})):t.ContactType()===i.ContactType.Payee&&(i.hasPayees=!0,e.mobile.changePage("#payOther",{transition:"none"}))},LoadingState:function(t){return{waitOnContacts:function(){var n=[],r=[];if(arguments.length>0){for(var i=0;i<arguments.length;i++){var s=arguments[i],o=s.handler.getPromise();o.done(function(e){e()}),r.push(o),n.push({func:s.retriever,handler:s.handler.action})}e.when.apply(null,r).then(function(){t()}),a.startBackgroundLoad();for(var u=0;u<n.length;u++)n[u].func(n[u].handler)}}}}(function(){l.contacts().length>0&&l.HasContacts(!0),setTimeout(function(){l.ShowContent(!0),a.loadFinished()},50)}),modifyActionIsDelete:function(){e("#modifyContactConfirm").popup("close"),setTimeout(function(){e("#deleteContactConfirm").popup("open")},300)},modifyActionIsEdit:function(){e("#modifyContactConfirm").popup("close"),i.selectedContactToEdit=l.contactToModify.ViewModelItem,setTimeout(function(){e.mobile.changePage("#editContact",{transition:"none"})},300)},acknowledgeDeletion:function(){e("#modifyContactConfirm").popup("close");if(l.contactToModify!==null){if(l.contactToModify.ViewModelItem.getContactType()===i.ContactType.Biller){var t={Id:l.contactToModify.ViewModelItem.Id};i.deleteBiller(t,l.deleteContactHandler)}if(l.contactToModify.ViewModelItem.getContactType()===i.ContactType.Payee){var n={Id:l.contactToModify.ViewModelItem.Id};i.deletePayee(n,l.deleteContactHandler)}}},deleteContactHandler:function(e){e.Success===!0&&(l.contactToModify.ViewModelItem.getContactType()===i.ContactType.Biller?l.showMessage(o.strings["msg.billerdeletedinfo"]):l.showMessage(o.strings["msg.contactdeleted"]),l.contacts.remove(l.contactToModify)),l.contactToModify=null},SelectContactToModify:function(t){l.contactToModify=t,e("#modifyContactConfirm").popup("open")},onAddContactClick:function(){e.mobile.changePage("#addContact")},contactToModify:null,infoMessage:r.observable(""),showMessage:function(t){l.infoMessage(t),e("#contactInfo").popup("open")},DisableModify:!1};l.TypeFilter.subscribe(function(e){e!=i.ContactType.All&&(i.addContactsFilter=e)});var c=function(e){var t=this;this.Id=e.Id,this.UserEnteredName=e.UserEnteredName,this.BillerCode=e.BillerCode,this.ShortName=e.ShortName,this.CustomerReferenceNumber=e.CRN,this.IsCRNConstant=e.IsCRNConstant,this.IsCRNPAN=e.IsCRNPAN,this.getMaskedCustomerReferenceNumber=function(){return t.CustomerReferenceNumber},this.getUserEnteredName=function(){return t.UserEnteredName},this.getContactType=function(){return i.ContactType.Biller},this.getDescriptionString=function(){return!t.UserEnteredName||0===t.UserEnteredName.length?t.ShortName:t.UserEnteredName},this.getSortableItem=function(){return t.getDescriptionString()},this.getMetaInfoString=function(){return t.IsCRNConstant?"Biller code "+t.BillerCode+", CRN "+t.getMaskedCustomerReferenceNumber():"Biller code "+t.BillerCode},this.getContactTypeImage=function(){return s.getContactTypeImageSrc(i.ContactType.Biller)}},h=function(e){var t=this;this.Id=e.Id,this.AccountName=e.Account.AccountName,this.AccountNumber=e.Account.AccountNumber,this.UserEnteredName=e.UserEnteredName,this.IsInternal=e.IsInternal,this.BSB=e.Account.BSBWithDash,this.BSBWithoutDash=e.Account.BSB,this.getUserEnteredName=function(){return t.UserEnteredName},this.getContactType=function(){return i.ContactType.Payee},this.getDescriptionString=function(){return!t.UserEnteredName||0===t.UserEnteredName.length?t.AccountName:t.UserEnteredName},this.getSortableItem=function(){return t.getDescriptionString()},this.getMetaInfoString=function(){return"BSB "+t.BSB+", Account no. "+t.AccountNumber},this.getContactTypeImage=function(){return s.getContactTypeImageSrc(i.ContactType.Payee)}},p=function(){var t=e.Deferred();return{action:function(n){if(n===undefined||n.Payees===undefined||n.Payees.length==0)t.resolve(function(){l.HasPayees(!1)});else{var r=function(){e.each(n.Payees,function(e,t){l.contacts.push(new f(new h(t)))}),t.resolve(function(){l.HasPayees(!0)}),i.allContacts=l.contacts,v()};a.loadFinished(r)}},getPromise:function(){return t.promise()}}},d=function(){var t=e.Deferred();return{action:function(n){if(n===undefined||n.Billers===undefined||n.Billers.length==0)t.resolve(function(){l.HasBillers(!1)});else{var r=function(){e.each(n.Billers,function(e,t){l.contacts.push(new f(new c(t)))}),t.resolve(function(){l.HasBillers(!0)}),i.allContacts=l.contacts,v()};a.loadFinished(r)}},getPromise:function(){return t.promise()}}},v=function(){i.newContactTypeAdded===i.ContactType.Payee?l.showMessage(o.strings["msg.payeesaved"]):i.newContactTypeAdded===i.ContactType.Biller&&l.showMessage(o.strings["msg.billersaved"]),i.newContactTypeAdded=null};t.viewModels.push(l),e("#contacts").on("pageinit",function(){l.reset(),r.applyBindings(l,e("#contacts").get(0))}),e("#contacts").on("pagebeforeshow",function(){l.reset(),i.activeContactsFilter!=null&&(l.TypeFilter(i.activeContactsFilter),l.InPickState(!0)),l.NoContactsMessage(o.strings["msg.nocontacts"]),l.NoPayeesMessage(o.strings["msg.nopayees"]),l.NoBillersMessage(o.strings["msg.nobillers"]),e("#ContactsFilterButtons:contains(a)").each(function(t,n){i.activeContactsFilter!=null?e(n).hide():e(n).show()}),l.LoadingState.waitOnContacts({retriever:i.getBillers,handler:d()},{retriever:i.getPayees,handler:p()})}),e("#contacts").on("pageshow",function(){i.selectedContact=null,a.show()}),e("#contacts").on("pagebeforehide",function(){i.activeContactsFilter=null}),e("#contacts").on("pagehide",function(){e('input[data-type="search"]').val(""),e('input[data-type="search"]').trigger("change")})})