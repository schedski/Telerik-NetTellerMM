define(["lib/jquery","lib/knockout","ui/loader","lib/accounting","netteller/accounts","netteller/transactions","netteller/payments","netteller/session","config/environment","lib/toolkit"],function(e,t,n,r,i,s,o,u,a,f){var l=new n.TimedLoader(a.strings["loader.accounts"]),c=new n.TimedLoader(a.strings["loader.payments"]),h,p=e.Deferred(),d=function(e){var n=this;this.AccountName=t.observable(e.AccountName),this.DisplayAccountName=t.observable(e.DisplayAccountName),this.BSB=t.observable(e.BSBWithDash),this.DisplayAccountNumber=t.observable(e.DisplayAccountNumber),this.AccountNumber=t.observable(e.AccountNumber),this.AvailableBalance=t.observable(Number(e.AvailableBalance)),this.DisplayAvailableBalance=t.computed(function(){return r.formatMoney(n.AvailableBalance())}),this.AccountNumAndName=n.DisplayAccountNumber()+": "+n.DisplayAccountName(),this.AccountNumNameAndAvailBal=n.AccountNumAndName+" ("+n.DisplayAvailableBalance()+")",this.AccountType=t.observable(e.AccountType)},v={allowTransfer:t.observable(!1),transferFromAccounts:t.observableArray([]),payOwnTransferFromSelectedAccount:t.observable(null),payOwnTransferFromSelectedAccountNameAndNum:t.observable(null),transferToAccounts:t.observableArray([]),payOwnTransferToSelectedAccount:t.observable(null),payOwnTransferToSelectedAccountNameAndNum:t.observable(null),description:t.observable("").extend({required:{params:!0,message:a.strings["msg.required"]}}),amount:t.observable("").extend({minAmount:.01}).extend({maxAmount:9999999999}),pageMessage:t.observable(""),reset:function(){v.transferFromAccounts([]),v.transferToAccounts([]),v.payOwnTransferFromSelectedAccount(null),v.payOwnTransferToSelectedAccount(null),v.amount(""),v.errors.showAllMessages(!1),v.pageMessage("")},accountSelectionChanged:function(){h&&g()},confirmPayOwnDetails:function(){if(g())return;if(v.errors().length>0){v.errors.showAllMessages();return}var t=v.amount();v.amount(parseFloat(isNaN(t)||t===""||t===null?0:t).toFixed(2)),v.payOwnTransferFromSelectedAccountNameAndNum(v.payOwnTransferFromSelectedAccount().DisplayAccountName()+" ("+v.payOwnTransferFromSelectedAccount().DisplayAccountNumber()+")"),v.payOwnTransferToSelectedAccountNameAndNum(v.payOwnTransferToSelectedAccount().DisplayAccountName()+" ("+v.payOwnTransferToSelectedAccount().DisplayAccountNumber()+")"),e("#payOwnConfirm").popup("open")},performPayOwnTransfer:function(){e("#payOwnConfirm").popup("close"),c.reset(),c.show(),o.executePayOwnFundsTransfer(v.payOwnTransferFromSelectedAccount().AccountNumber(),v.payOwnTransferToSelectedAccount().AccountNumber(),v.amount(),v.description(),o.frequency.Immediate,b),p.done(function(t){t!==null&&t!==undefined&&t.length>0&&f.displayPageMessage(v,"pageMessage",t,e("#payOwnMessagePopup"))})}};v.errors=t.validation.group(v);var m={transferFromAccountNumAndName:t.observable(),transferToAccountNumAndName:t.observable(),amount:t.observable(),cbsReceiptNumber:t.observable(),description:t.observable(),reset:function(){m.transferFromAccountNumAndName(""),m.transferToAccountNumAndName(""),m.amount(""),m.cbsReceiptNumber(""),m.description("")}};u.viewModels.push(v),u.viewModels.push(m);var g=function(){var t=v;return t.payOwnTransferFromSelectedAccount()!==undefined&&t.payOwnTransferToSelectedAccount()!==undefined?t.payOwnTransferFromSelectedAccount().AccountNumber()===t.payOwnTransferToSelectedAccount().AccountNumber()?(f.displayPageMessage(v,"pageMessage",a.strings["msg.transferfromandtoaccountssame"],e("#payOwnMessagePopup")),!0):!1:!1},y=function(t){var n=function(){h=!1,v.transferFromAccounts.removeAll(),v.transferToAccounts.removeAll(),e.each(t.TransferFromAccounts.Accounts,function(e,t){v.transferFromAccounts.push(new d(t))}),e.each(t.TransferToAccounts.Accounts,function(e,t){v.transferToAccounts.push(new d(t))}),h=!0;var n=!1,r=t.TransferFromAccounts.Accounts.length==1&&t.TransferToAccounts.Accounts.length==1,i=t.TransferFromAccounts.Accounts[0].AccountNumber==t.TransferToAccounts.Accounts[0].AccountNumber;r&&i?f.displayPageMessage(v,"pageMessage",a.strings["msg.cannotpayowntransfer"],e("#payOwnMessagePopup")):(v.transferToAccounts().length>0?v.payOwnTransferToSelectedAccount(v.transferToAccounts()[1]):v.transferFromAccounts().length>0&&v.payOwnTransferFromSelectedAccount(v.transferFromAccounts()[1]),n=!1),v.allowTransfer(!n)};t.TransferFromAccounts===undefined||t.TransferToAccounts===undefined||t.TransferFromAccounts.Accounts.length===0||t.TransferToAccounts.Accounts.length===0?(v.allowTransfer(!1),f.displayPageMessage(v,"pageMessage",a.strings["msg.noaccounts"],e("#payOwnMessagePopup")),l.loadFinished()):l.loadFinished(n)},b=function(t){t.Success?(m.transferFromAccountNumAndName(t.FromDisplayAccountName+" ("+t.FromDisplayAccountNumber+")"),m.transferToAccountNumAndName(t.ToDisplayAccountName+" ("+t.ToDisplayAccountNumber+")"),m.amount(v.amount()),m.description(v.description()),m.cbsReceiptNumber(t.CBSReceiptNumber),c.loadFinished(),e.mobile.changePage("#payOwnSuccess")):(c.loadFinished(function(){p.resolve(t.ErrorMessage),p=e.Deferred()}),e("#payOwnConfirm").popup("close"))};e("#payOwn").on("pageinit",function(){t.applyBindings(v,e("#payOwn").get(0)),t.applyBindings(m,e("#payOwnSuccess").get(0))}),e("#payOwn").on("pagebeforeshow",function(){l.reset(),l.startBackgroundLoad(),i.getAccountsForMyOwnTransfer(y),v.amount(""),v.description(""),v.pageMessage(""),v.errors.showAllMessages(!1),v.allowTransfer(!1)}),e("#payOwn").on("pageshow",function(){l.show()})})