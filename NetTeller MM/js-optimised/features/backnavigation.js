define(["lib/jquery","features/logout","ui/platform!","ui/loader","ui/startup"],function(e,t,n,r){var i=(navigator&&navigator.app&&navigator.app.exitApp?navigator.app.exitApp:null)||(navigator&&navigator.device&&navigator.device.exitApp?navigator.device.exitApp:null)||(window.device&&window.device.exitApp?window.device.exitApp:null)||e.noop,s={home:{rules:[{trigger:"*",target:i}]},loginPassword:{rules:[{trigger:"*",target:"home"}]},pinkeypad:{rules:[{trigger:"home",target:"home"}]},register:{rules:[{trigger:"loginPassword",target:t.confirmLogout},{trigger:"settings",target:"settings"}]},accounts:{rules:[{trigger:"*",target:t.confirmLogout}]},transactions:{rules:[{trigger:"*",target:"accounts"}]},payments:{rules:[{trigger:"*",target:"accounts"}]},payOwn:{rules:[{trigger:"*",target:"payments"}]},payBpay:{rules:[{trigger:"*",target:"payments"}]},payOther:{rules:[{trigger:"*",target:"payments"}]},payBpayReceipt:{rules:[{trigger:"*",target:"payments"}]},payOtherReceipt:{rules:[{trigger:"*",target:"payments"}]},payOwnSuccess:{rules:[{trigger:"*",target:"payments"}]},contacts:{rules:[{trigger:"payOther",target:"payOther"},{trigger:"payBpay",target:"payBpay"},{trigger:"*",target:"accounts"}]},addContact:{rules:[{trigger:"payOther",target:"payOther"},{trigger:"payBpay",target:"payBpay"},{trigger:"*",target:"contacts"}]},settings:{rules:[{trigger:"*",target:"accounts"}]},registerExistingPin:{rules:[{trigger:"loginPassword",target:t.confirmLogout},{trigger:"settings",target:"settings"}]}},o={};o.getPrevId=function(){var t=null,n=e.mobile.urlHistory.stack[e.mobile.urlHistory.stack.length-2];return typeof n!="undefined"&&n!=null&&(t=n.url,t.indexOf("/")!=-1&&t.indexOf("#")===-1&&(t="home")),t},o.processTarget=function(t){e.isFunction(t)?t():e.mobile.changePage("#"+t)},o.processRules=function(e){var t=s[e].rules,n=o.getPrevId();for(var r=0;r<t.length;r++){var i=t[r].trigger,u=t[r].target;if(i==="*")return o.processTarget(u),!0;if(i===n)return o.processTarget(u),!0}return!1},o.transition=function(){var t=e.mobile.activePage.attr("id"),n=o.getPrevId(),r=!1;typeof t!="undefined"&&typeof s[t]!="undefined"&&s[t]!==null&&(r=s[t].hasOwnProperty("rules")&&o.processRules(t)),r||e.mobile.changePage("#"+n)},window.noPhoneGap||n.features.hasBackKey&&document.addEventListener("backbutton",function(e){r.active||o.transition(),e.preventDefault(),e.stopPropagation()}),e(".back-button").on("click",function(e){o.transition()})})