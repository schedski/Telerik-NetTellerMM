define(["lib/jquery","lib/knockout","lib/underscore","lib/toolkit","config/client","ui/startup"],function(e,t,n,r,i){var s={},o=function(n){var i=this;this.lat=n.latitude||"unset",this.lon=n.longitude||"unset",this.name=n.name||"",this.address=n.address||"",this.type=r.cleanField(n.type||"atm"),this.hasRendered=!1,this.marker=null,this.infoWindow=null,this.hasValidLocation=function(){return i.lat!=="unset"&&i.lon!=="unset"},this.getLatLng=function(){return new s.LatLng(i.lat,i.lon)},this.getDistanceFrom=function(e){var t=6371,n=(e.lat-i.lat)*Math.PI/180,r=(e.lon-i.lon)*Math.PI/180,s=i.lat*Math.PI/180,o=e.lat*Math.PI/180,u=Math.sin(n/2)*Math.sin(n/2)+Math.sin(r/2)*Math.sin(r/2)*Math.cos(s)*Math.cos(o),a=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u));return t*a},this.getImage=function(){if(i.type=="atm")return"images/build/findus/atm-icon-32.png";if(i.type=="branch")return"images/build/findus/branch-icon-32.png";if(i.type=="me")return"images/build/findus/self-icon-20.png";throw"Unknown type!"},this.getInfoHtml=function(){i.hasAddress=r.hasValue(i.address),i.infoBoxClass="info-box-"+i.type,i.nearTo=null,i.fromMe=null;if(i.type==="me"){var n=c();i.nearTo={name:n.name,address:n.address,distance:n.getDistanceFrom(i).toFixed(2)}}else f.hasValidLocation()&&(i.fromMe={distance:i.getDistanceFrom(f).toFixed(2)});var s=document.createElement("div");return e(s).attr("data-bind","template: 'atm-infobox-template'"),t.applyBindings(i,s),s},this.renderMarker=function(t){if(!i.hasValidLocation())return;if(i.hasRendered){i.type==="me"&&i.marker.setPosition(i.getLatLng());return}i.hasRendered=!0;var n={position:i.getLatLng(),map:t,icon:i.getImage(),title:i.name},r={maxWidth:e(window).width()/2};i.marker=new s.Marker(n),i.infoWindow=new s.InfoWindow(r),s.event.addListener(i.marker,"click",function(){i.infoWindow.setContent(i.getInfoHtml()),i.infoWindow.open(t,i.marker)}),i.marker.setMap(t)}},u=[],a=!1,f=new o({type:"me",name:"You are here"}),l=null,c=function(){return u.length===0?null:n.min(u,function(e){return e.getDistanceFrom(f)})},h=function(){var e=this;this.message=t.observable(""),this.reset=function(){e.message("")}},p=new h,d=function(){e.each(u,function(e,t){t.renderMarker(l)}),f.renderMarker(l);if(f.hasValidLocation()){var t=c();p.message("Nearest branch is "+t.name)}},v=function(){a===!1&&(a=!0,e.ajax({url:"atms.json",dataType:"json",success:function(t){u.length=0,e.each(t,function(e,t){u.push(new o(t))}),d(),m()},error:function(){p.message("Unable to get ATM data:  "+textStatus)}}))},m=function(){var e=c();if(f.hasValidLocation()&&e!==null){var t=new google.maps.Circle,n=(f.getDistanceFrom(e)+.2)*1e3;t.setRadius(n*.5),t.setCenter(f.getLatLng()),l.fitBounds(t.getBounds())}else l.setCenter(new s.LatLng(-25.363882,133.718994)),l.setZoom(3)},g=function(e){f.lat=e.coords.latitude,f.lon=e.coords.longitude,d(),m()},y=function(e){var t="An issues has occured: ";switch(e.code){case e.PERMISSION_DENIED:t+="User denied the request for Geolocation.";break;case e.POSITION_UNAVAILABLE:t+="Location information is unavailable.";break;case e.TIMEOUT:t+="The request to get user location timed out.";break;case e.UNKNOWN_ERROR:t+="An unknown error occurred."}p.message(t)},b=function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(g,y):p.message("Geolocation is not supported by this browser.")},w=function(){if(l===null){var t={panControl:!1,scaleControl:!1,zoomControl:!1,mapTypeControl:!1,navigationControl:!1,streetViewControl:!1,mapTypeId:s.MapTypeId.ROADMAP};l=new s.Map(e("#map_canvas").get(0),t)}},E=function(){var t=e(window).height();e("#findUs > :visible").filter(function(){return!e(this).hasClass("map")}).each(function(){t-=e(this).outerHeight()}),e("#map_canvas").height(t),s.event.trigger(l,"resize"),m()},S=function(){if(S.loaded===!0)return e.Deferred().resolve();S.loaded=!0;var t=e.Deferred();return window.mapsLoaded=function(){delete window.mapsLoaded,s=window.google.maps,t.resolve()},require(["http://maps.googleapis.com/maps/api/js?key="+i.googleMapsKey+"&sensor=false&callback=mapsLoaded"]),t},x;e("#findUs").on("pagebeforeshow",function(){t.applyBindings(p,e("#findUs").get(0)),x=e.Deferred();var n=S();n.done(function(){w(),v()}),e.when(n,x).done(function(){b(),window.setTimeout(E,100)})}),e("#findUs").on("pageshow",function(){x.resolve()}),e("#findUs").on("pagehide",function(){p.reset()}),e(window).resize(function(){e(".map").css("top","0px"),E()})})