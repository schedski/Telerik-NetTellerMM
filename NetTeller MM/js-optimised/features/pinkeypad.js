define(["lib/jquery","netteller/session","ui/loader","lib/knockout","netteller/login","netteller/pin","netteller/security","netteller/localstorage","config/environment","ui/platform!","ui/canvasKeypad","ui/startup"],function(e,t,n,r,i,s,o,u,a,f,l){var c=function(){var e=[],t=65;for(var n=0;n<s.pinLength;n++)e[n]="ui-block-"+String.fromCharCode(t+n).toLowerCase();return e},h=r.observable(""),p,d=e("#forgotPinPopup"),v={pinCode:r.observable(""),pinCodeBoxes:c(),errorMessage:r.observable(""),isSubmitting:!1,pinInfoMessage:r.computed(function(){var e=s.pinMode();return e===s.pinModeEnum.Login?a.strings["lang.intro.loginpin"]:h()!==null&&h().length>0?a.strings["lang.intro.registrationpinconfirm"]:e===s.pinModeEnum.Register||e===s.pinModeEnum.RegisterFromSettings?a.strings["lang.intro.registrationpin"]:e===s.pinModeEnum.Change?a.strings["lang.intro.loginpin"]:""}),hiddenPinDigit:function(e){return e<v.pinCode().length?"*":" "},forgotPinText:r.computed(function(){return s.pinMode()===s.pinModeEnum.Login?a.strings["lang.link.forgotpin"]:" "}),forgotPin:function(e){s.pinMode()===s.pinModeEnum.Login&&e.done(function(){d.popup("open")})},forgetYes:function(){e.mobile.changePage("#loginPassword")},forgetNo:function(){d.popup("close")},titleText:r.computed(function(){var e=s.pinMode();return e===s.pinModeEnum.Login?a.strings["lang.title.login"]:e===s.pinModeEnum.Register||e===s.pinModeEnum.RegisterFromSettings?a.strings["lang.title.register"]:e===s.pinModeEnum.Change||h()!==null&&h().length>0?a.strings["lang.title.changepin"]:""}),updatePin:function(e,t){if(v.isSubmitting==1)return;e>s.pinLength&&(e=e.substring(0,s.pinLength)),v.pinCode(e),e.length===s.pinLength&&t.done(v.submit)},submit:function(){var e=s.pinMode();e===s.pinModeEnum.Login?(v.isSubmitting=!0,g()):e===s.pinModeEnum.Register||e===s.pinModeEnum.RegisterFromSettings?m()&&(v.isSubmitting=!0,b()):e===s.pinModeEnum.Change&&m()&&y()},clearPin:function(){v.pinCode(""),p.Reset()},reset:function(){v.clearPin(),v.errorMessage(""),v.isSubmitting=!1,h("")}},m=function(){return h()===""?s.isValidPin(v.pinCode())?(h(v.pinCode()),v.clearPin(),!1):(v.clearPin(),v.errorMessage(a.strings["msg.pininvalid"]),e("#errorMessagePopup").popup("open"),!1):h()!==v.pinCode()?(v.clearPin(),h(""),v.errorMessage(a.strings["msg.pinmatch"]),e("#errorMessagePopup").popup("open"),!1):!0},g=function(){var e=u.getPinLoginToken(),n=u.getTokenId();i.loginLoader.reset(),i.loginLoader.show(),t.pinLogin(v.pinCode,e,n,!1,w)},y=function(){E=new n.TimedLoader(a.strings["loader.pinchange"]),E.show(),t.changePin(v.pinCode,v.pinCode,S)},b=function(){E=new n.TimedLoader(a.strings["loader.pinregister"]),E.show(),t.registerPin(v.pinCode,S)},w=function(t,n,r){var s=function(){t?r.State===i.responseCommand.MustAcceptTermsAndConditions?(i.setTermsAndConditions(r),i.pinCode(v.pinCode()),e.mobile.changePage("#loginTerms"),v.reset()):r.State===i.responseCommand.AcceptLogin?i.doAcceptLoginWorkFlowStep(w):r.State===i.responseCommand.LoginProcessAccepted?(o.isLoggedIn=!0,o.isTokenOwner(!0),e.mobile.changePage("#accounts"),v.reset()):r.State==i.responseCommand.ForcePasswordChange&&(e.mobile.changePage("#passwordChange"),v.reset()):r.IsLockedOut?(v.reset(),v.errorMessage(a.strings["msg.pindisabled"]),e("#errorMessagePopup").on("popupafterclose",function(t){e("#errorMessagePopup").unbind("popupafterclose"),e.mobile.changePage("#loginPassword")}),e("#errorMessagePopup").popup("open")):(v.reset(),v.errorMessage(n),e("#errorMessagePopup").popup("open"),o.isLoggedIn=!1)};i.loginLoader.loadFinished(s)},E,S=function(t,n){var r=function(){if(n!==null){s.pinMode()===s.pinModeEnum.Register?(u.registerPin(n.PinLoginToken,n.TokenId),o.isTokenOwner(!0),v.reset(),e.mobile.changePage("#accounts")):s.pinMode()===s.pinModeEnum.Change?(v.reset(),s.settingsPageStatus(a.strings["msg.pinregistered"]),e.mobile.changePage("#settings")):s.pinMode()===s.pinModeEnum.RegisterFromSettings&&(u.registerPin(n.PinLoginToken,n.TokenId),o.isTokenOwner(!0),v.reset(),s.settingsPageStatus(a.strings["msg.pinregistered"]),e.mobile.changePage("#settings"));return}v.errorMessage(t),e("#errorMessagePopup").popup("open")};E.loadFinished(r)};t.viewModels.push(v),r.applyBindings(v,e("#pinKeypad").get(0));var x=function(t){var n=e("#pinKeypad #contentArea"),r=e("#pinEntryArea").outerHeight(!0)+e('#pinKeypad [data-role="header"]').outerHeight(!0)+(n.innerHeight()-n.height())+t;e("#pinEntryArea").height(r),p.CalculateDimensions(5,!0),p.Render()};p=new l.Keypad({canvas:"#keypadCanvas",limitHeight:!0,onAdjustLayout:x,availableHeight:function(){return e(window).height()-e('#pinKeypad [data-role="header"]').outerHeight(!0)-e("#pinEntryArea").outerHeight(!0)},onUpdateText:v.updatePin}),e("#pinKeypad").on("pagebeforeshow",function(){i.loginMode(i.loginModeEnum.Pin),v.reset(),f.android41plus&&(e("#contentArea").css("overflow-x","visible"),e("#keypadCanvas").css("position","absolute")),p.ConfigureLayout({name:"pin",options:{maxdigits:4,forgotpinHandler:s.pinMode()===s.pinModeEnum.Login?v.forgotPin:null}}),p.CalculateDimensions(30,!0)}),e("#pinKeypad").on("pageshow",function(){i.loginMode(i.loginModeEnum.Pin),v.reset(),p.CalculateDimensions(30,!1),p.Render(),p.BindEvents(),p.SetKeysActive(!0)}),e("#pinKeypad").on("beforepagehide",function(){p.SetKeysActive(!1)}),e("#pinKeypad").on("pagehide",function(){v.errorMessage(""),v.pinCode("")})})