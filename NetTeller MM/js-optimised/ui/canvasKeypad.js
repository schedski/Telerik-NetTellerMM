define(["lib/jquery","ui/platform!","lib/toolkit","ui/startup"],function(e,t,n){var r=!t.android2x,i={pin:null,number:null};e.getJSON("keypadlayouts.json",function(t){e.each(t,function(e,t){i[t.name]=t})});var s=function(t){this.Layout=[];var s={canvas:null,availableHeight:function(){return 0},limitHeight:!1,paddingTop:10,paddingBottom:0,textScaling:.5,minActiveTime:100,onUpdateText:function(e,t){},onAdjustLayout:function(){}};t=e.extend({},s,t);var o=e(t.canvas),u=o.get(0).getContext("2d"),a=0,f=0,l=this,c={data:[],maxsize:640},h=null,p,d,v,m,g,y=!0;this.SetKeysActive=function(e){y=e},this.Reset=function(){c.data=[]},this.AppendToBuffer=function(e){c.data.length+1<=c.maxsize&&c.data.push(e)},this.BufferToString=function(){var e="";for(var t=0;t<c.data.length;t++)e+=c.data[t];return e},this.RemoveFromBuffer=function(){c.data.length>0&&c.data.pop()},this.MaxHeight=function(){return t.limitHeight?88*a:Math.pow(2,32)-1},this.CalculateDimensions=function(n,r){p=e(window).height();var i=Math.min(l.MaxHeight(),t.availableHeight()-n);d=Math.min(i,Math.floor(e(window).width()/f*a)),v=e(window).width(),m=Math.floor((d-(t.paddingTop+t.paddingBottom))/a),g=Math.floor(v/f),o.height(d),o.width(v),o.attr("width",v),o.attr("height",d),r||t.limitHeight&&t.availableHeight()>l.MaxHeight()&&t.onAdjustLayout(t.availableHeight()-l.MaxHeight())};var b=[],w=function(){var t=e.Deferred();return window.setTimeout(t.resolve,310),b.push(t),t};this.Keys={},this.Keys.BaseKey=function(){this.textScaling=t.textScaling,this.setDefaultTextStyle=function(){var e=h===this&&r;u.textAlign="center",u.textBaseline="middle";var t=Math.floor(m*this.textScaling);u.font=t.toString()+"px Helvetica, Arial, sans-serif",u.fillStyle=e?"#000":"#fff",u.globalAlpha=e?1:.75},this.drawActiveState=function(){var e=h===this&&r;if(e){var t=h.getTopLeftCorner();u.globalAlpha=1,u.fillStyle="#bbb",u.fillRect(t.x+1,t.y+1,g-1,m-1)}},this.getTopLeftCorner=function(){return{x:this.column*g,y:t.paddingTop+this.row*m}},this.getCentre=function(){var e=this.getTopLeftCorner();return{x:Math.floor(e.x+g*.5),y:Math.floor(e.y+m*.5)}},this.drawText=function(e){var t=this.getCentre();u.fillText(e,t.x,t.y)}},this.Keys.Digit=function(e){var n=this;this.render=function(){n.drawActiveState(),n.setDefaultTextStyle(),n.drawText(e.toString())},this.click=function(){l.AppendToBuffer(e.toString()),t.onUpdateText(l.BufferToString(),w())}},this.Keys.Digit.prototype=new this.Keys.BaseKey,this.Keys.Decimalpoint=function(){var e=this;this.render=function(){e.drawActiveState(),e.setDefaultTextStyle(),e.drawText(".")},this.click=function(){l.AppendToBuffer("."),t.onUpdateText(l.BufferToString(),w())}},this.Keys.Decimalpoint.prototype=new this.Keys.BaseKey,this.Keys.Backspace=function(){var n=this;this.render=function(){var t=h===this&&r,i=e(t?"#backspace-img-active":"#backspace-img"),s=i.width()/i.height(),o=Math.floor(m/4),a=Math.floor(o*s),f=n.getCentre(),l=Math.floor(f.x-a/2),c=Math.floor(f.y-o/2);n.drawActiveState(),u.drawImage(i.get(0),l,c,a,o)},this.click=function(){l.RemoveFromBuffer(),t.onUpdateText(l.BufferToString(),w())}},this.Keys.Backspace.prototype=new this.Keys.BaseKey,this.Keys.Forgot=function(e,t){var n=this;this.textScaling=l.Keys.Forgot.prototype.textScaling/3,this.render=function(){n.drawActiveState(),n.setDefaultTextStyle(),n.drawText(e)},this.click=function(){t(w())}},this.Keys.Forgot.prototype=new this.Keys.BaseKey,this.Keys.Submit=function(e,t){var n=this;this.render=function(){n.drawActiveState(),n.setDefaultTextStyle(),n.drawText(e)},this.click=function(){t(w())}},this.Keys.Submit.prototype=new this.Keys.BaseKey,this.Keys.Dummy=function(e){var t=this;this.render=function(){},this.click=function(){}},this.Keys.Dummy.prototype=new this.Keys.BaseKey,this.ConfigureLayout=function(t){l.Layout=[];if(n.hasValue(t.name)){var r=i[t.name];if(r!==null&&r!==undefined){var s=!1,o=!1;t.name==="pin"&&(o="forgotpinHandler"in t.options&&typeof t.options.forgotpinHandler=="function"&&t.options.forgotpinHandler!==null,c.maxsize=t.options.maxdigits),t.name==="number"&&(s="showdecimal"in t.options&&t.options.showdecimal),a=parseInt(r.rows),f=parseInt(r.columns),e.each(r.keys,function(e,n){n.type!==undefined&&(n.type==="digit"?l.Layout.push(new l.Keys.Digit(parseInt(n.value))):n.type==="forgotpin"?o?l.Layout.push(new l.Keys.Forgot(n.value,t.options.forgotpinHandler)):l.Layout.push(new l.Keys.Dummy):n.type==="backspace"?l.Layout.push(new l.Keys.Backspace):n.type==="dummy"?l.Layout.push(new l.Keys.Dummy):n.type==="submit"?l.Layout.push(new l.Keys.Submit(n.value,t.submitHandler)):n.type==="decimalpoint"&&(s?l.Layout.push(new l.Keys.Decimalpoint):l.Layout.push(new l.Keys.Dummy)))});for(var u=0;u<l.Layout.length;u++)l.Layout[u].column=u%f,l.Layout[u].row=Math.floor(u/f)}}},this.RenderStage={},this.RenderStage.Keys=function(){for(var e=0;e<l.Layout.length;e++)l.Layout[e].render()},this.RenderStage.BeforeKeys=function(){u.fillStyle="#232323",u.globalAlpha=1,u.fillRect(0,t.paddingTop,v,d-(t.paddingTop+t.paddingBottom)),u.strokeStyle="#ffffff";for(var e=0;e<a;e++){var n=t.paddingTop+e*m+.5,r=n+1,i=r+(m-2),s=Math.floor(v/2)+.5,o=u.createLinearGradient(s,r,s,i);u.globalAlpha=.1,o.addColorStop(0,"#fff"),o.addColorStop(1,"#000"),u.fillStyle=o,u.rect(0,r,v,i-r),u.fill(),u.globalAlpha=.5,u.beginPath(),u.moveTo(0,n),u.lineTo(v,n),u.stroke()}for(e=1;e<f;e++){var l=e*g;u.beginPath(),u.moveTo(l,t.paddingTop),u.lineTo(l,d-t.paddingBottom),u.stroke()}},this.RenderOrder=[this.RenderStage.BeforeKeys,this.RenderStage.Keys],this.Render=function(){for(var e=0;e<l.RenderOrder.length;e++)l.RenderOrder[e]()},this.BindEvents=function(){if(o.data("events-bound")!==!0){o.data("events-bound",!0);var n=function(e){var n=e.x,r=e.y-t.paddingTop,i=Math.floor(r/m),s=Math.floor(n/g);return l.Layout[i*f+s]},i;r&&(i=e.Deferred(),i.resolve());var s=function(e){if(!y)return;var t=n(e);t.click(),r&&i.done(function(){h=null,l.Render()})},u=function(r){i=e.Deferred(),window.setTimeout(i.resolve,t.minActiveTime),h=n(r),l.Render()},a=function(e){var t=null;return e.targetTouches&&e.targetTouches.length>0?t=e.targetTouches[0]:e.changedTouches&&e.changedTouches.length>0&&(t=e.changedTouches[0]),t!==null?{x:t.clientX,y:t.clientY-(p-d)}:null},c=function(e){return{x:e.clientX,y:e.clientY-(p-d)}},v=function(e){e.preventDefault(),e.stopImmediatePropagation()},w=o.get(0);e.mobile.support.touch?(r&&(w.addEventListener("touchstart",function(e){u(a(e)),v(e)}),w.addEventListener("touchmove",function(e){u(a(e)),v(e)})),w.addEventListener("touchend",function(e){s(a(e)),v(e)})):(r&&w.addEventListener("mousedown",function(e){u(c(e)),v(e)}),w.addEventListener("mouseup",function(e){s(c(e)),v(e)})),w.addEventListener("click",function(e){while(b.length>0)b.shift().resolve();e.preventDefault(),e.stopImmediatePropagation()})}}};return{Keypad:s}})