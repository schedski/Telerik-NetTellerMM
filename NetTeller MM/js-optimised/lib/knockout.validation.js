/*
===============================================================================
Author: Eric M. Barnard - @ericmbarnard
License: MIT (http://opensource.org/licenses/mit-license.php)
Description: Validation Library for KnockoutJS
===============================================================================
*/

(function(e){typeof require=="function"&&typeof exports=="object"&&typeof module=="object"?e(require("knockout"),exports):typeof define=="function"&&define.amd?define(["lib/knockout","exports"],e):e(ko,ko.validation={})})(function(e,t){function a(e,n,r){return n.validator(e(),r.params===undefined?!0:r.params)?!0:(e.error=t.formatMessage(r.message||n.message,r.params),e.__valid__(!1),!1)}function f(e,n,r){e.isValidating(!0);var i=function(i){var s=!1,o="";if(!e.__valid__()){e.isValidating(!1);return}i.message?(s=i.isValid,o=i.message):s=i,s||(e.error=t.formatMessage(o||r.message||n.message,r.params),e.__valid__(s)),e.isValidating(!1)};n.validator(e(),r.params||!0,i)}if(typeof e===undefined)throw"Knockout is required, please ensure it is loaded before loading this validation plug-in";typeof define=="function"&&define.amd&&(t=e.validation={});var n={registerExtenders:!0,messagesOnModified:!0,errorsAsTitleOnModified:!1,messageTemplate:null,insertMessages:!0,parseInputAttributes:!1,writeInputAttributes:!1,decorateElement:!1,errorClass:null,errorElementClass:"validationElement",errorMessageClass:"validationMessage",grouping:{deep:!1,observable:!0}},r=e.utils.extend({},n),i=["required","pattern","min","max","step"],s=function(e){window.setImmediate?window.setImmediate(e):window.setTimeout(e,0)},o=function(){var e=(new Date).getTime(),t={},n="__ko_validation__";return{isArray:function(e){return e.isArray||Object.prototype.toString.call(e)==="[object Array]"},isObject:function(e){return e!==null&&typeof e=="object"},values:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t},getValue:function(e){return typeof e=="function"?e():e},hasAttribute:function(e,t){return e.getAttribute(t)!==null},isValidatable:function(e){return e&&e.rules&&e.isValid&&e.isModified},insertAfter:function(e,t){e.parentNode.insertBefore(t,e.nextSibling)},newId:function(){return e+=1},getConfigOptions:function(e){var t=o.contextFor(e);return t||r},setDomData:function(e,r){var i=e[n];i||(e[n]=i=o.newId()),t[i]=r},getDomData:function(e){var r=e[n];return r?t[r]:undefined},contextFor:function(e){switch(e.nodeType){case 1:case 8:var t=o.getDomData(e);if(t)return t;if(e.parentNode)return o.contextFor(e.parentNode)}return undefined},isEmptyVal:function(e){if(e===undefined)return!0;if(e===null)return!0;if(e==="")return!0}}}(),u=function(){var s=0;return{utils:o,init:function(n,i){if(s>0&&!i)return;n=n||{},n.errorElementClass=n.errorElementClass||n.errorClass||r.errorElementClass,n.errorMessageClass=n.errorMessageClass||n.errorClass||r.errorMessageClass,e.utils.extend(r,n),r.registerExtenders&&t.registerExtenders(),s=1},configure:function(e){t.init(e)},reset:function(){r=$.extend(r,n)},group:function(n,i){var i=e.utils.extend(r.grouping,i),s=e.observableArray([]),u=null,a=function f(t,n){var r=[],u=e.utils.unwrapObservable(t);n=n!==undefined?n:i.deep?1:-1,e.isObservable(t)&&(t.isValid||t.extend({validatable:!0}),s.push(t)),u&&(o.isArray(u)?r=u:o.isObject(u)&&(r=o.values(u))),n!==0&&e.utils.arrayForEach(r,function(e){e&&!e.nodeType&&f(e,n+1)})};return i.observable?(a(n),u=e.computed(function(){var t=[];return e.utils.arrayForEach(s(),function(e){e.isValid()||t.push(e.error)}),t})):u=function(){var t=[];return s([]),a(n),e.utils.arrayForEach(s(),function(e){e.isValid()||t.push(e.error)}),t},u.showAllMessages=function(t){t==undefined&&(t=!0),u(),e.utils.arrayForEach(s(),function(e){e.isModified(t)})},n.errors=u,n.isValid=function(){return n.errors().length===0},n.isAnyMessageShown=function(){var t=!1;return u(),e.utils.arrayForEach(s(),function(e){!e.isValid()&&e.isModified()&&(t=!0)}),t},u},formatMessage:function(e,t){return typeof e=="function"?e(t):e.replace(/\{0\}/gi,t)},addRule:function(e,t){return e.extend({validatable:!0}),e.rules.push(t),e},addAnonymousRule:function(e,n){var r=o.newId();n.message===undefined&&(n.message="Error"),t.rules[r]=n,t.addRule(e,{rule:r,params:n.params})},addExtender:function(n){e.extenders[n]=function(e,r){return r.message||r.onlyIf?t.addRule(e,{rule:n,message:r.message,params:o.isEmptyVal(r.params)?!0:r.params,condition:r.onlyIf}):t.addRule(e,{rule:n,params:r})}},registerExtenders:function(){if(r.registerExtenders)for(var n in t.rules)t.rules.hasOwnProperty(n)&&(e.extenders[n]||t.addExtender(n))},insertValidationMessage:function(e){var t=document.createElement("SPAN");return t.className=o.getConfigOptions(e).errorMessageClass,o.insertAfter(e,t),t},parseInputValidationAttributes:function(n,r){e.utils.arrayForEach(i,function(e){o.hasAttribute(n,e)&&t.addRule(r(),{rule:e,params:n.getAttribute(e)||!0})})},writeInputValidationAttributes:function(t,n){var r=n();if(!r||!r.rules)return;var s=r.rules();e.utils.arrayForEach(i,function(n){var r,i=e.utils.arrayFirst(s,function(e){return e.rule.toLowerCase()===n.toLowerCase()});if(!i)return;r=i.params,i.rule=="pattern"&&i.params instanceof RegExp&&(r=i.params.source),t.setAttribute(n,r)}),s=null}}}();u.rules={},u.rules.required={validator:function(e,t){var n=/^\s+|\s+$/g,r;return e===undefined||e===null?!t:(r=e,typeof e=="string"&&(r=e.replace(n,"")),t?(r+"").length>0:!0)},message:"This field is required."},u.rules.min={validator:function(e,t){return o.isEmptyVal(e)||e>=t},message:"Please enter a value greater than or equal to {0}."},u.rules.max={validator:function(e,t){return o.isEmptyVal(e)||e<=t},message:"Please enter a value less than or equal to {0}."},u.rules.minLength={validator:function(e,t){return o.isEmptyVal(e)||e.length>=t},message:"Please enter at least {0} characters."},u.rules.maxLength={validator:function(e,t){return o.isEmptyVal(e)||e.length<=t},message:"Please enter no more than {0} characters."},u.rules.pattern={validator:function(e,t){return o.isEmptyVal(e)||e.match(t)!=null},message:"Please check this value."},u.rules.step={validator:function(e,t){return o.isEmptyVal(e)||e*100%(t*100)===0},message:"The value must increment by {0}"},u.rules.email={validator:function(e,t){return t?o.isEmptyVal(e)||t&&/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i.test(e):!0},message:"Please enter a proper email address"},u.rules.date={validator:function(e,t){return t?o.isEmptyVal(e)||t&&!/Invalid|NaN/.test(new Date(e)):!0},message:"Please enter a proper date"},u.rules.dateISO={validator:function(e,t){return t?o.isEmptyVal(e)||t&&/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(e):!0},message:"Please enter a proper date"},u.rules.number={validator:function(e,t){return t?o.isEmptyVal(e)||t&&/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test(e):!0},message:"Please enter a number"},u.rules.digit={validator:function(e,t){return t?o.isEmptyVal(e)||t&&/^\d+$/.test(e):!0},message:"Please enter a digit"},u.rules.phoneUS={validator:function(e,t){return t?typeof e!="string"?!1:o.isEmptyVal(e)?!0:(e=e.replace(/\s+/g,""),t&&e.length>9&&e.match(/^(1-?)?(\([2-9]\d{2}\)|[2-9]\d{2})-?[2-9]\d{2}-?\d{4}$/)):!0},message:"Please specify a valid phone number"},u.rules.equal={validator:function(e,t){var n=t;return e===o.getValue(n)},message:"Values must equal"},u.rules.notEqual={validator:function(e,t){var n=t;return e!==o.getValue(n)},message:"Please choose another value."},u.rules.unique={validator:function(t,n){var r=o.getValue(n.collection),i=o.getValue(n.externalValue),s=0;return!t||!r?!0:(e.utils.arrayFilter(e.utils.unwrapObservable(r),function(e){t===(n.valueAccessor?n.valueAccessor(e):e)&&s++}),s<(i!==undefined&&t!==i?1:2))},message:"Please make sure the value is unique."},function(){u.registerExtenders()}(),e.bindingHandlers.validationCore=function(){return{init:function(n,r,i,u,a){var f=o.getConfigOptions(n);f.parseInputAttributes&&s(function(){t.parseInputValidationAttributes(n,r)});if(f.insertMessages&&o.isValidatable(r())){var l=t.insertValidationMessage(n);f.messageTemplate?e.renderTemplate(f.messageTemplate,{field:r()},null,l,"replaceNode"):e.applyBindingsToNode(l,{validationMessage:r()})}f.writeInputAttributes&&o.isValidatable(r())&&t.writeInputValidationAttributes(n,r),f.decorateElement&&o.isValidatable(r())&&e.applyBindingsToNode(n,{validationElement:r()})},update:function(e,t,n,r,i){}}}(),function(){var t=e.bindingHandlers.value.init;e.bindingHandlers.value.init=function(n,r,i,s,o){return t(n,r,i),e.bindingHandlers.validationCore.init(n,r,i,s,o)}}(),e.bindingHandlers.validationMessage={update:function(t,n){var r=n(),i=o.getConfigOptions(t),s=e.utils.unwrapObservable(r),u=null,a=!1,f=!1;r.extend({validatable:!0}),a=r.isModified(),f=r.isValid();var l=function(){return!i.messagesOnModified||a?f?null:r.error:null},c=function(){return a?!f:!1};e.bindingHandlers.text.update(t,l),e.bindingHandlers.visible.update(t,c)}},e.bindingHandlers.validationElement={update:function(t,n){var r=n(),i=o.getConfigOptions(t),s=e.utils.unwrapObservable(r),u=null,a=!1,f=!1;r.extend({validatable:!0}),a=r.isModified(),f=r.isValid();var l=function(){var e={},t=a?!f:!1;return i.decorateElement||(t=!1),e[i.errorElementClass]=t,e};e.bindingHandlers.css.update(t,l);var c=t.getAttribute("data-orig-title"),h=t.title,p=t.getAttribute("data-orig-title")=="true",d=function(){if(!i.errorsAsTitleOnModified||a)return f?{title:c||h,"data-orig-title":null}:{title:r.error,"data-orig-title":c||h}};e.bindingHandlers.attr.update(t,d)}},e.bindingHandlers.validationOptions=function(){return{init:function(t,n,i,s,u){var a=e.utils.unwrapObservable(n());if(a){var f=e.utils.extend({},r);e.utils.extend(f,a),o.setDomData(t,f)}}}}(),e.extenders.validation=function(n,r){return e.utils.arrayForEach(o.isArray(r)?r:[r],function(e){t.addAnonymousRule(n,e)}),n},e.extenders.validatable=function(n,r){if(r&&!o.isValidatable(n)){n.error=null,n.rules=e.observableArray(),n.isValidating=e.observable(!1),n.__valid__=e.observable(!0),n.isModified=e.observable(!1);var i=e.computed(function(){var e=n(),r=n.rules();return t.validateObservable(n),!0});n.isValid=e.computed(function(){return n.__valid__()});var s=n.subscribe(function(){n.isModified(!0)});n._disposeValidation=function(){n.isValid.dispose(),n.rules.removeAll(),n.isModified._subscriptions.change=[],n.isValidating._subscriptions.change=[],n.__valid__._subscriptions.change=[],s.dispose(),i.dispose(),delete n.rules,delete n.error,delete n.isValid,delete n.isValidating,delete n.__valid__,delete n.isModified}}else r===!1&&o.isValidatable(n)&&n._disposeValidation&&n._disposeValidation();return n},u.validateObservable=function(e){var n=0,r,i,s=e.rules(),o=s.length;for(;n<o;n++){i=s[n];if(i.condition&&!i.condition())continue;r=t.rules[i.rule];if(r.async||i.async)f(e,r,i);else if(!a(e,r,i))return!1}return e.error=null,e.__valid__(!0),!0},e.validatedObservable=function(n){if(!t.utils.isObject(n))return e.observable(n).extend({validatable:!0});var r=e.observable(n);return r.errors=t.group(n),r.isValid=e.computed(function(){return r.errors().length===0}),r},u.localize=function(e){var n,r;for(r in e)t.rules.hasOwnProperty(r)&&(t.rules[r].message=e[r])},e.applyBindingsWithValidation=function(n,r,i){var s=arguments.length,o,u;s>2?(o=r,u=i):s<2?o=document.body:arguments[1].nodeType?o=r:u=arguments[1],t.init(),u&&t.utils.setDomData(o,u),e.applyBindings(n,r)};var l=e.applyBindings;e.applyBindings=function(e,n){t.init(),l(e,n)},e.utils.extend(t,u)})